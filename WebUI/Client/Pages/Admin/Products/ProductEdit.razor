@page "/admin/productos/editar/{id:int}"
@inject HttpClient httpClient
@inject NavigationManager navManager
@inject IJSRuntime jsr
@inject IImageService imgService
@inject IDialogService DialogService

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator/>    
    <MudCard>
        <MudCardContent>
            <MudTextField Label="Nombre" HelperText="Max. 20 characters"
                            @bind-Value="model.Name" For="@(() => model.Name)"/>
            <MudNumericField Label="Precio" @bind-Value="model.Price" For="@(() => model.Price)"/>
            <MudTextField Label="Categoria" @bind-Value="@model.Category" For="@(() => model.Category)"></MudTextField>
            <MudTextField Label="Descripcion" @bind-Value="@model.Description" For="@(() => model.Description)" Lines="5"></MudTextField>
            <MudText>Fotos</MudText>
            <MudGrid Justify="Justify.FlexStart">
            @foreach(var photo in model.Photos)
            {
                <MudItem xs="3">
                    <div class="d-flex justify-content-end"  style="overflow:hidden">
				        <MudImage src="@imgService.GetImageSrc(photo.Bytes)" Style="object-fit:contain;width:100%;"></MudImage>
                        <MudButton @onclick="@(() => DeleteImage(photo))" Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete" Size="Size.Small" Style="position:absolute;" Class="m-2"></MudButton>
			        </div>
                </MudItem>
            }
        </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Guardar</MudButton>
        </MudCardActions>
    </MudCard>    
</EditForm>
<MudFileUpload T="IBrowserFile" Accept=".png, .jpg" FilesChanged="UploadFiles" MaximumFileCount="6">
    <ButtonTemplate>
        <MudButton HtmlTag="label"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    StartIcon="@Icons.Material.Filled.CloudUpload"
                    for="@context">
            Only image files
        </MudButton>
    </ButtonTemplate>
</MudFileUpload>
@code {
    private Product model { get; set; } = new Product();
    [Parameter]
    public int? Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var requestMessage = new HttpRequestMessage(HttpMethod.Get, $"/api/products/{Id}");
        var response = await httpClient.SendAsync(requestMessage);
        if (response.IsSuccessStatusCode)
        {
            model = await response.Content.ReadFromJsonAsync<Product>() ?? new Product();
        }
    }

    private async Task OnValidSubmit(EditContext context)
    {
        var response = await httpClient.PutAsJsonAsync("api/products", model);
        navManager.NavigateTo("admin/productos");
    }

    private async Task UploadFiles(IBrowserFile file)
    {
        // Create Array of bytes with file content
        var buffer = new byte[file.Size];    
        await file.OpenReadStream().ReadAsync(buffer);
        // Create array of bytes with the resized image content
        //var imgSrc = "data:image/jpeg;base64," + Convert.ToBase64String(buffer);
        var resizedBuffer = imgService.ResizeImage(buffer);
        // Create CatPhoto with the resized image bytes
        var newPhoto = new ProductPhoto()
        {
            Bytes = resizedBuffer,
            Description = file.Name,
            FileExtension = file.ContentType,
            Size = file.Size,
        };    
        // Add the photo instance to the list
        model.Photos.Add(newPhoto);
    }

    private async Task DeleteImage(ProductPhoto photo) {
        var parameters = new DialogParameters();
        parameters.Add("ContentText", "Estas seguro de que quieres borrar esta foto? Si guardas estos cambios no podras recuperarla.");
        parameters.Add("ButtonText", "Borrar");
        parameters.Add("Color", Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = DialogService.Show<Dialog>("Borrar", parameters, options);
        DialogResult result = await dialog.Result;

        if (!result.Canceled)
        {
            model.Photos.Remove(photo);
        }
	}

}