@page "/admin/editar/{id:int}"
@inject HttpClient httpClient
@inject NavigationManager navManager
@inject IJSRuntime jsr

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator/>    
    <MudCard>
        <MudCardContent>
            <MudTextField Label="Nombre" HelperText="Max. 8 characters"
                            @bind-Value="model.Name" For="@(() => model.Name)"/>
            <MudDatePicker Label="Fecha de nacimiento" @bind-Date="model.DateOfBirth" For="@(() => model.DateOfBirth)"/>
            <MudCheckBox Label="Esterilizado" @bind-Checked="@model.IsSterilized"></MudCheckBox>
            <MudCheckBox Label="Con chip" @bind-Checked="@model.HasChip"></MudCheckBox>
            <MudCheckBox Label="Vacunado" @bind-Checked="@model.IsVaccinated"></MudCheckBox>
        </MudCardContent>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Guardar</MudButton>
        </MudCardActions>
    </MudCard>    
</EditForm>
@code {
    private Cat cat { get; set; } = new Cat();
    private CatBindingTarget model { get; set; } = new CatBindingTarget();
    private Cat savedCat { get; set; } = new Cat();
    [Parameter]
    public int? Id { get; set; }
    private string token { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        var userdata = await jsr.InvokeAsync<string>("localStorage.getItem", "user").ConfigureAwait(false);
        if (!string.IsNullOrWhiteSpace(userdata))
        {
            var dataArray = userdata.Split(';', 2);
            if (dataArray.Length == 2)
            {
                token = dataArray[1]; 
            }
        }
        //cat = await httpClient.GetFromJsonAsync<Cat>($"api/Cats/{Id}") ?? new Cat();

        var requestMessage = new HttpRequestMessage(HttpMethod.Get, $"/api/cats/{Id}");
        requestMessage.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
        var response = await httpClient.SendAsync(requestMessage);
        if (response.IsSuccessStatusCode)
        {
            cat = await response.Content.ReadFromJsonAsync<Cat>() ?? new Cat();
        }
        model.Name = cat.Name ?? "";
        model.DateOfBirth = cat.DateOfBirth;
        model.HasChip = cat.HasChip;
        model.IsSterilized = cat.IsVaccinated;
        model.IsSterilized = cat.IsSterilized;
    }

    private async Task OnValidSubmit(EditContext context)
    {
        savedCat = model.ToCat();
        savedCat.Id = cat.Id;
        var response = await httpClient.PutAsJsonAsync("api/Cats", savedCat);
        var result = await response.Content.ReadFromJsonAsync<Cat>() ?? new Cat();
        navManager.NavigateTo("admin/gatos");
    }

}